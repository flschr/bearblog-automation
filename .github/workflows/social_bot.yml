name: Social Bot

run-name: ${{ github.event_name == 'repository_dispatch' && 'Updated RSS feed detected' || 'Manual social_bot run' }}

on:
  #schedule:
  #  - cron: '*/50 * * * *' # Runs every 50 minutes (can be disabled if using external trigger)
  workflow_dispatch: # Allows manual trigger
  repository_dispatch: # Allows external trigger (e.g., from Cloudflare Worker)
    types: [rss_feed_update]

# Ensure only one instance runs at a time to prevent duplicate posts
# cancel-in-progress: true queues concurrent runs instead of running in parallel
# This prevents race conditions that could cause duplicate posts
concurrency:
  group: social-bot
  cancel-in-progress: true

permissions:
  contents: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      changes: ${{ steps.save_state.outputs.changes }}
    steps:
      - name: Show Trigger Info
        run: |
          echo "ðŸš€ Workflow triggered by: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ðŸ“¡ Triggered by Cloudflare Worker RSS Monitor"
            echo "ðŸ”” Event type: ${{ github.event.action }}"
            echo "ðŸ“‹ Changed feeds: ${{ toJson(github.event.client_payload.feeds) }}"
            echo "â° Triggered at: ${{ github.event.client_payload.triggered_at }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "â±ï¸ Triggered by scheduled cron job"
          else
            echo "ðŸ‘¤ Manually triggered"
          fi

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r bots/social_bot/requirements.txt

      - name: Process Retry Queue
        env:
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_PW: ${{ secrets.BSKY_PW }}
          MASTO_TOKEN: ${{ secrets.MASTO_TOKEN }}
        run: |
          echo "Processing retry queue for articles with partial failures..."
          python bots/social_bot/process_retry_queue.py || echo "Retry queue processor completed with warnings"

      - name: Run Social Bot
        env:
          BSKY_HANDLE: ${{ secrets.BSKY_HANDLE }}
          BSKY_PW: ${{ secrets.BSKY_PW }}
          MASTO_TOKEN: ${{ secrets.MASTO_TOKEN }}
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
        run: python bots/social_bot/social_bot.py

      - name: Create Issue for Unmatched Articles
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPORT_FILE="bots/social_bot/unmatched_articles.json"
          if [ -f "$REPORT_FILE" ]; then
            echo "Found unmatched articles report, creating issue..."

            # Build issue body with the report
            ISSUE_BODY="## Unmatched Articles Report

          The following articles were found in the RSS feed but did not match any posting configuration.
          Please review and update the config if needed.

          ### Workflow Run
          - **Run ID:** ${{ github.run_id }}
          - **Triggered by:** ${{ github.event_name }}
          - **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Detailed Report
          \`\`\`json
          $(cat "$REPORT_FILE")
          \`\`\`

          ### Possible Actions
          1. Add a matching rule to \`bots/social_bot/config.json\`
          2. Add the article URL to \`posted_articles.txt\` to skip it
          3. Check if the article has the expected tags in the RSS feed
          "

            # Create the issue (without labels to avoid errors if they don't exist)
            echo "$ISSUE_BODY" | gh issue create \
              --title "Social Bot: Unmatched articles found" \
              --body-file -

            # Clean up the report file (don't commit it)
            rm "$REPORT_FILE"
          else
            echo "No unmatched articles report found"
          fi

      - name: Create Issue for Partial Failures
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPORT_FILE="bots/social_bot/partial_failures.json"
          if [ -f "$REPORT_FILE" ]; then
            echo "Found partial failures report, creating issue..."

            # Build issue body with the report
            ISSUE_BODY="## Partial Posting Failures

          Some articles were posted to some platforms but failed on others.
          Manual intervention may be required.

          ### Workflow Run
          - **Run ID:** ${{ github.run_id }}
          - **Triggered by:** ${{ github.event_name }}
          - **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Detailed Report
          \`\`\`json
          $(cat "$REPORT_FILE")
          \`\`\`

          ### Possible Actions
          1. Manually post to the failed platform(s)
          2. Check the error message for the root cause
          3. Fix the issue and re-run the bot (note: this may create duplicates on successful platforms)
          "

            # Create the issue
            echo "$ISSUE_BODY" | gh issue create \
              --title "Social Bot: Partial posting failures" \
              --body-file -

            # Clean up the report file (don't commit it)
            rm "$REPORT_FILE"
          else
            echo "No partial failures report found"
          fi

      - name: Report Exhausted Retries
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check for articles that have exhausted all retry attempts
          EXHAUSTED_COUNT=$(python3 -c "
          import json
          import sys
          from pathlib import Path

          retry_queue_file = Path('bots/social_bot/retry_queue.json')
          if not retry_queue_file.exists():
              sys.exit(0)

          try:
              with open(retry_queue_file) as f:
                  queue = json.load(f)
              exhausted = [e for e in queue.values() if e.get('next_retry_after') == 'exhausted']
              print(len(exhausted))
              if exhausted:
                  print(json.dumps(exhausted, indent=2), file=sys.stderr)
          except Exception as e:
              print(f'Error: {e}', file=sys.stderr)
              sys.exit(0)
          " 2>&1)

          if [ ! -z "$EXHAUSTED_COUNT" ] && [ "$EXHAUSTED_COUNT" -gt 0 ]; then
            echo "Found $EXHAUSTED_COUNT article(s) that exhausted all retry attempts"

            # Create issue for exhausted retries
            ISSUE_BODY="## Retry Queue Exhausted

          The following articles have exhausted all retry attempts and could not be posted to all platforms.
          Manual intervention is required.

          ### Workflow Run
          - **Run ID:** ${{ github.run_id }}
          - **Triggered by:** ${{ github.event_name }}
          - **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Action Required
          Please manually post these articles to the failed platforms, then remove them from the retry queue.

          Run this to see details:
          \`\`\`bash
          cat bots/social_bot/retry_queue.json | jq '.[] | select(.next_retry_after == \"exhausted\")'
          \`\`\`
          "

            echo "$ISSUE_BODY" | gh issue create \
              --title "Social Bot: Retry queue exhausted ($EXHAUSTED_COUNT articles)" \
              --body-file -
          else
            echo "No exhausted retries found"
          fi

      - name: Save State
        id: save_state
        run: |
          git config user.name "Bot"
          git config user.email "bot@github.com"

          # Add files that exist (some may not exist if there's nothing to track)
          for file in bots/social_bot/posted_articles.txt bots/social_bot/feed_cache.json bots/social_bot/retry_queue.json mappings.json; do
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done

          # "|| exit 0" prevents error if there are no changes to commit
          if git commit -m "Update posted articles and feed cache"; then
            echo "changes=true" >> $GITHUB_OUTPUT
            # Pull latest changes before pushing to avoid conflicts with parallel workflows
            git pull --rebase origin main
            git push
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

  trigger-backup:
    needs: build
    if: needs.build.outputs.changes == 'true'
    uses: ./.github/workflows/backup_bot.yml
    secrets: inherit
