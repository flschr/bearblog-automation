name: Fetch Webmentions

run-name: Fetch blog webmentions from webmention.io

on:
  schedule:
    - cron: '0 */6 * * *' # Runs every 6 hours
  workflow_dispatch: # Allows manual trigger

# Ensure only one instance runs at a time to prevent data conflicts
concurrency:
  group: webmentions-fetch
  cancel-in-progress: true

permissions:
  contents: write
  issues: write

jobs:
  fetch-webmentions:
    runs-on: ubuntu-latest
    steps:
      - name: Show Trigger Info
        run: |
          echo "üîó Fetching webmentions from webmention.io"
          echo "üìÖ Triggered by: ${{ github.event_name }}"
          echo "‚è∞ Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install requests PyYAML

      - name: Fetch Webmentions
        env:
          WEBMENTION_IO_TOKEN: ${{ secrets.WEBMENTION_IO_TOKEN }}
          BEARBLOG_DOMAIN: ${{ secrets.BEARBLOG_DOMAIN }}
        run: |
          echo "Fetching webmentions for domain: $BEARBLOG_DOMAIN"
          python bots/webmentions_bot/fetch_webmentions.py

      - name: Commit Webmentions Data
        run: |
          git config user.name "Webmentions Bot"
          git config user.email "bot@github.com"

          # Check if webmentions.json exists and has changes
          if [ -f "webmentions.json" ]; then
            git add webmentions.json

            # Commit if there are changes
            if git diff --staged --quiet; then
              echo "No new webmentions to commit"
            else
              echo "New webmentions found, committing..."
              git commit -m "Update webmentions data"

              # Pull latest changes before pushing to avoid conflicts
              git pull --rebase origin ${{ github.ref_name }}
              git push
            fi
          else
            echo "No webmentions.json file generated"
          fi

      - name: Create GitHub Issue for New Webmentions
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPORT_FILE="bots/webmentions_bot/new_mentions.json"

          if [ -f "$REPORT_FILE" ]; then
            python bots/webmentions_bot/create_issue_body.py

            if [ -f "bots/webmentions_bot/issue_body.md" ]; then
              MENTION_COUNT=$(jq 'length' "$REPORT_FILE")

              gh issue create \
                --title "New Webmentions: $MENTION_COUNT new mention(s) received" \
                --body-file bots/webmentions_bot/issue_body.md

              rm -f bots/webmentions_bot/issue_body.md "$REPORT_FILE"
            fi
          else
            echo "No new mentions to report"
          fi
